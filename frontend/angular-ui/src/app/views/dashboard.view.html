<section class="dashboard-shell">
  <header class="hero">
    <h1>MLForecast Control Room</h1>
    <p>S&amp;P 500 stock price forecasting with multi-model ensemble ML pipeline.</p>
  </header>

  <!-- System Status Banner -->
  <section class="panel status-panel" *ngIf="systemStatus">
    <div class="status-grid">
      <div class="status-item" [class.ready]="systemStatus.has_data">
        <span class="status-icon">{{ systemStatus.has_data ? '‚úì' : '‚óã' }}</span>
        <span>Data {{ systemStatus.has_data ? 'Available' : 'Not Downloaded' }}</span>
      </div>
      <div class="status-item" [class.ready]="systemStatus.has_model">
        <span class="status-icon">{{ systemStatus.has_model ? '‚úì' : '‚óã' }}</span>
        <span>Model {{ systemStatus.has_model ? 'Trained' : 'Not Trained' }}</span>
      </div>
      <div class="status-item" [class.ready]="systemStatus.ready_for_predictions">
        <span class="status-icon">{{ systemStatus.ready_for_predictions ? '‚úì' : '‚óã' }}</span>
        <span>{{ systemStatus.ready_for_predictions ? 'Ready for Predictions' : 'Setup Required' }}</span>
      </div>
    </div>
    <div class="data-stats" *ngIf="systemStatus.data_stats">
      <small>
        {{ systemStatus.data_stats.companies }} companies |
        {{ systemStatus.data_stats.rows | number }} data points |
        {{ systemStatus.data_stats.start_date | date:'mediumDate' }} - {{ systemStatus.data_stats.end_date | date:'mediumDate' }}
      </small>
    </div>
  </section>

  <!-- Background Task Progress -->
  <section class="panel task-panel" *ngIf="currentTask && currentTask.status === 'running'">
    <h3>
      <span class="spinner"></span>
      {{ currentTask.task_type === 'data_update' ? 'Downloading Data' :
         currentTask.task_type === 'model_training' ? 'Training Model' : 'Running Pipeline' }}
    </h3>
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="currentTask.progress"></div>
    </div>
    <p class="task-message">{{ currentTask.message }} ({{ currentTask.progress | number:'1.0-0' }}%)</p>
  </section>

  <p class="success" *ngIf="successMessage">{{ successMessage }}</p>
  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <!-- Company Selection Panel -->
  <section class="panel company-selection">
    <h2>Select Companies ({{ selectedIds.length }} selected of {{ allCompanies.length }} available)</h2>

    <p class="info-note" *ngIf="allCompanies.length > 0 && allCompanies.length < 500">
      üìä Data available for {{ allCompanies.length }} companies. Click "Update Data" to download more.
    </p>
    <p class="info-note warning" *ngIf="allCompanies.length === 0 && !isLoading">
      ‚ö†Ô∏è No data available. Click "Download & Train" to get started.
    </p>

    <div class="filters" *ngIf="allCompanies.length > 0">
      <label>
        Search
        <input type="text" [(ngModel)]="searchQuery" placeholder="Search by ticker or name..." />
      </label>
      <label>
        Sector
        <select [(ngModel)]="selectedSector">
          <option value="">All Sectors</option>
          <option *ngFor="let sector of allSectors" [value]="sector">{{ sector }}</option>
        </select>
      </label>
      <div class="selection-actions">
        <button type="button" class="btn-secondary" (click)="selectAll()">Select All ({{ filteredCompanies.length }})</button>
        <button type="button" class="btn-secondary" (click)="clearSelection()">Clear</button>
      </div>
    </div>

    <div class="company-grid" *ngIf="!isLoading && allCompanies.length > 0">
      <div
        *ngFor="let company of filteredCompanies | slice:0:100"
        class="company-card"
        [class.selected]="isSelected(company.ticker)"
        (click)="toggleSelection(company.ticker)">
        <span class="ticker">{{ company.symbol }}</span>
        <span class="name">{{ company.name }}</span>
        <span class="sector">{{ company.sector }}</span>
      </div>
    </div>
    <p class="loading" *ngIf="isLoading">Loading companies...</p>
    <p class="table-note" *ngIf="filteredCompanies.length > 100">
      Showing first 100 of {{ filteredCompanies.length }} companies. Use search to narrow results.
    </p>

    <!-- Selected companies summary -->
    <div class="selected-summary" *ngIf="selectedIds.length > 0">
      <strong>Selected:</strong>
      <span class="selected-tags">
        <span *ngFor="let id of selectedIds | slice:0:10" class="tag" (click)="toggleSelection(id)">
          {{ id.replace('.US', '') }} √ó
        </span>
        <span *ngIf="selectedIds.length > 10" class="tag more">+{{ selectedIds.length - 10 }} more</span>
      </span>
    </div>
  </section>

  <!-- Pipeline Controls -->
  <section class="panel actions">
    <h2>Pipeline Controls</h2>

    <div class="action-buttons">
      <div class="button-group">
        <button type="button" class="btn-primary" (click)="runPipeline(true)"
                [disabled]="currentTask && currentTask.status === 'running'">
          {{ currentTask?.status === 'running' ? 'Task Running...' : 'üöÄ Download & Train (Full Pipeline)' }}
        </button>
      </div>

      <div class="button-group">
        <button type="button" class="btn-secondary" (click)="startDataUpdate()"
                [disabled]="currentTask && currentTask.status === 'running'">
          üì• Update Data Only
        </button>
        <button type="button" class="btn-secondary" (click)="startTraining(false)"
                [disabled]="!systemStatus?.has_data || (currentTask && currentTask.status === 'running')">
          üß† Train Model Only
        </button>
      </div>

      <div class="button-group">
        <button type="button" (click)="loadMetrics(true)" [disabled]="isLoadingMetrics">
          {{ isLoadingMetrics ? 'Loading...' : 'üìä Refresh Metrics' }}
        </button>
      </div>
    </div>

    <!-- Training Options -->
    <div class="training-options" *ngIf="systemStatus?.has_data">
      <h3>Training Options</h3>
      <div class="training-ticker-selection">
        <p *ngIf="trainingTickers.length === 0">
          Training will use <strong>all {{ allCompanies.length }} companies</strong>.
        </p>
        <p *ngIf="trainingTickers.length > 0">
          Training will use <strong>{{ trainingTickers.length }} selected companies</strong>.
          <small class="info-hint">üí° The trained model can still generate forecasts for any company with available data.</small>
        </p>
        <div class="training-actions">
          <button type="button" class="btn-small" (click)="setTrainingTickers()"
                  [disabled]="selectedIds.length === 0">
            Use Selected ({{ selectedIds.length }}) for Training
          </button>
          <button type="button" class="btn-small" (click)="clearTrainingTickers()"
                  *ngIf="trainingTickers.length > 0">
            Use All Companies
          </button>
          <button type="button" class="btn-small btn-primary" (click)="startTraining(true)"
                  *ngIf="trainingTickers.length > 0"
                  [disabled]="currentTask && currentTask.status === 'running'">
            Train on Selected
          </button>
        </div>
      </div>
    </div>

    <div class="forecast-form">
      <label>
        Horizon (days)
        <input type="number" min="1" max="90" [(ngModel)]="horizon" />
      </label>

      <label>
        History (days)
        <input type="number" min="10" max="365" [(ngModel)]="historyDays" />
      </label>

      <label>
        Confidence Levels
        <input type="text" [(ngModel)]="levels" placeholder="80,95" />
      </label>

      <button type="button" class="btn-primary" (click)="runForecast()"
              [disabled]="isForecasting || selectedIds.length === 0">
        {{ isForecasting ? 'Forecasting...' : 'üîÆ Generate Forecast' }}
      </button>
      <small class="forecast-hint" *ngIf="selectedIds.length === 0">Select at least one company</small>
    </div>
  </section>


  <section class="panel summary" *ngIf="summary">
    <h2>Pipeline Summary</h2>
    <div class="summary-grid">
      <article>
        <span>Rows</span>
        <strong>{{ summary.rows | number }}</strong>
      </article>
      <article>
        <span>Series</span>
        <strong>{{ summary.unique_series }}</strong>
      </article>
      <article>
        <span>Start</span>
        <strong>{{ summary.start | date:'mediumDate' }}</strong>
      </article>
      <article>
        <span>End</span>
        <strong>{{ summary.end | date:'mediumDate' }}</strong>
      </article>
      <article>
        <span>Models</span>
        <strong>{{ summary.trained_models.length }}</strong>
      </article>
    </div>
  </section>

  <!-- Model Accuracy Chart -->
  <section class="panel chart-panel" *ngIf="metrics.length > 0">
    <h2>Model Accuracy Comparison</h2>
    <app-metrics-chart [metrics]="metrics"></app-metrics-chart>
  </section>

  <!-- Forecast Chart with History -->
  <section class="panel chart-panel" *ngIf="records.length > 0 || historyRecords.length > 0">
    <h2>Price History &amp; Forecast</h2>
    <div class="chart-controls">
      <div class="model-selector" *ngIf="availableModels.length > 0">
        <label>
          Model:
          <select [(ngModel)]="selectedModel">
            <option *ngFor="let model of availableModels" [value]="model">{{ model }}</option>
          </select>
        </label>
      </div>
      <label class="backtest-toggle" *ngIf="backtestRecords.length > 0">
        <input type="checkbox" [(ngModel)]="showBacktest" />
        Show Model Predictions on History
      </label>
      <div class="chart-legend">
        <span class="legend-solid">‚îÅ Actual</span>
        <span class="legend-dotted" *ngIf="showBacktest && backtestRecords.length > 0">‚îÑ Predicted</span>
        <span class="legend-dashed">‚îÖ Forecast</span>
      </div>
    </div>
    <p class="backtest-message" *ngIf="backtestMessage">{{ backtestMessage }}</p>
    <app-forecast-chart
      [records]="records"
      [historyRecords]="historyRecords"
      [backtestRecords]="showBacktest ? backtestRecords : []"
      [selectedModel]="selectedModel">
    </app-forecast-chart>
  </section>

  <section class="panel results" *ngIf="records.length > 0">
    <h2>Forecast Records</h2>
    <table>
      <thead>
        <tr>
          <th>Series</th>
          <th>Date</th>
          <th>Model</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of records | slice:0:50">
          <td>{{ row.unique_id }}</td>
          <td>{{ row.ds | date:'yyyy-MM-dd' }}</td>
          <td>{{ row.model_name }}</td>
          <td>{{ row.value | number:'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
    <p class="table-note" *ngIf="records.length > 50">
      Showing first 50 of {{ records.length }} records.
    </p>
  </section>

  <section class="panel results" *ngIf="metrics.length > 0">
    <h2>Model Accuracy (Cross-Validation)</h2>
    <table>
      <thead>
        <tr>
          <th>Model</th>
          <th>sMAPE</th>
          <th>WAPE</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let metric of metrics">
          <td>{{ metric.model }}</td>
          <td>{{ metric.smape | number:'1.2-2' }}</td>
          <td>{{ metric.wape | number:'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
  </section>
</section>
