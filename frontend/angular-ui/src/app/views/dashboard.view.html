<section class="dashboard-shell">
  <header class="hero">
    <h1>MLForecast Control Room</h1>
    <p>S&amp;P 500 stock price forecasting with multi-model ensemble ML pipeline.</p>
  </header>

  <!-- Company Selection Panel -->
  <section class="panel company-selection">
    <h2>Select Companies ({{ selectedIds.length }} selected)</h2>

    <div class="filters">
      <label>
        Search
        <input type="text" [(ngModel)]="searchQuery" placeholder="Search by ticker or name..." />
      </label>
      <label>
        Sector
        <select [(ngModel)]="selectedSector">
          <option value="">All Sectors</option>
          <option *ngFor="let sector of allSectors" [value]="sector">{{ sector }}</option>
        </select>
      </label>
      <div class="selection-actions">
        <button type="button" class="btn-secondary" (click)="selectAll()">Select All ({{ filteredCompanies.length }})</button>
        <button type="button" class="btn-secondary" (click)="clearSelection()">Clear</button>
      </div>
    </div>

    <div class="company-grid" *ngIf="!isLoading">
      <div
        *ngFor="let company of filteredCompanies | slice:0:100"
        class="company-card"
        [class.selected]="isSelected(company.ticker)"
        (click)="toggleSelection(company.ticker)">
        <span class="ticker">{{ company.symbol }}</span>
        <span class="name">{{ company.name }}</span>
        <span class="sector">{{ company.sector }}</span>
      </div>
    </div>
    <p class="loading" *ngIf="isLoading">Loading S&amp;P 500 companies...</p>
    <p class="table-note" *ngIf="filteredCompanies.length > 100">
      Showing first 100 of {{ filteredCompanies.length }} companies. Use search to narrow results.
    </p>

    <!-- Selected companies summary -->
    <div class="selected-summary" *ngIf="selectedIds.length > 0">
      <strong>Selected:</strong>
      <span class="selected-tags">
        <span *ngFor="let id of selectedIds | slice:0:10" class="tag" (click)="toggleSelection(id)">
          {{ id.replace('.US', '') }} ×
        </span>
        <span *ngIf="selectedIds.length > 10" class="tag more">+{{ selectedIds.length - 10 }} more</span>
      </span>
    </div>
  </section>

  <!-- Pipeline Controls -->
  <section class="panel actions">
    <div class="action-buttons">
      <button type="button" (click)="runPipeline()" [disabled]="isRunningPipeline">
        {{ isRunningPipeline ? 'Running Pipeline...' : 'Run Pipeline' }}
      </button>
      <button type="button" (click)="loadMetrics(true)" [disabled]="isLoadingMetrics">
        {{ isLoadingMetrics ? 'Loading...' : 'Refresh Metrics' }}
      </button>
    </div>

    <div class="forecast-form">
      <label>
        Horizon (days)
        <input type="number" min="1" max="90" [(ngModel)]="horizon" />
      </label>

      <label>
        History (days)
        <input type="number" min="10" max="365" [(ngModel)]="historyDays" />
      </label>

      <label>
        Confidence Levels
        <input type="text" [(ngModel)]="levels" placeholder="80,95" />
      </label>

      <button type="button" class="btn-primary" (click)="runForecast()" [disabled]="isForecasting || !summary || selectedIds.length === 0">
        {{ isForecasting ? 'Forecasting...' : 'Generate Forecast' }}
      </button>
    </div>
  </section>

  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <section class="panel summary" *ngIf="summary">
    <h2>Pipeline Summary</h2>
    <div class="summary-grid">
      <article>
        <span>Rows</span>
        <strong>{{ summary.rows | number }}</strong>
      </article>
      <article>
        <span>Series</span>
        <strong>{{ summary.unique_series }}</strong>
      </article>
      <article>
        <span>Start</span>
        <strong>{{ summary.start | date:'mediumDate' }}</strong>
      </article>
      <article>
        <span>End</span>
        <strong>{{ summary.end | date:'mediumDate' }}</strong>
      </article>
      <article>
        <span>Models</span>
        <strong>{{ summary.trained_models.length }}</strong>
      </article>
    </div>
  </section>

  <!-- Model Accuracy Chart -->
  <section class="panel chart-panel" *ngIf="metrics.length > 0">
    <h2>Model Accuracy Comparison</h2>
    <app-metrics-chart [metrics]="metrics"></app-metrics-chart>
  </section>

  <!-- Forecast Chart with History -->
  <section class="panel chart-panel" *ngIf="records.length > 0 || historyRecords.length > 0">
    <h2>Price History &amp; Forecast</h2>
    <div class="chart-controls">
      <div class="model-selector" *ngIf="availableModels.length > 0">
        <label>
          Model:
          <select [(ngModel)]="selectedModel">
            <option *ngFor="let model of availableModels" [value]="model">{{ model }}</option>
          </select>
        </label>
      </div>
      <div class="chart-legend">
        <span class="legend-solid">━ History</span>
        <span class="legend-dashed">┅ Forecast</span>
      </div>
    </div>
    <app-forecast-chart
      [records]="records"
      [historyRecords]="historyRecords"
      [selectedModel]="selectedModel">
    </app-forecast-chart>
  </section>

  <section class="panel results" *ngIf="records.length > 0">
    <h2>Forecast Records</h2>
    <table>
      <thead>
        <tr>
          <th>Series</th>
          <th>Date</th>
          <th>Model</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let row of records | slice:0:50">
          <td>{{ row.unique_id }}</td>
          <td>{{ row.ds | date:'yyyy-MM-dd' }}</td>
          <td>{{ row.model_name }}</td>
          <td>{{ row.value | number:'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
    <p class="table-note" *ngIf="records.length > 50">
      Showing first 50 of {{ records.length }} records.
    </p>
  </section>

  <section class="panel results" *ngIf="metrics.length > 0">
    <h2>Model Accuracy (Cross-Validation)</h2>
    <table>
      <thead>
        <tr>
          <th>Model</th>
          <th>sMAPE</th>
          <th>WAPE</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let metric of metrics">
          <td>{{ metric.model }}</td>
          <td>{{ metric.smape | number:'1.2-2' }}</td>
          <td>{{ metric.wape | number:'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
  </section>
</section>
